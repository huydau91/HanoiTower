<!DOCTYPE html>
<html>
<head>
	<title>Test OOP</title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<script src="js/jquery-3.2.1.min.js"></script>
	<script src="js/d3.js"></script>
</head>
<body style="background: #d9edf7;">
	<div class="container" style="margin-top: 3rem;">
		<div style="text-align: center; margin-bottom: 5rem;">
			<p style="text-transform: uppercase; font-size: 3rem; margin-bottom: 4rem;">hanoi towers</p>
			<input>
			<button onclick="callbuild()">Create Tower</button>
			<button onclick="callmove()">Start</button>
		</div>
	</div>

	<script type="text/javascript">
		let svg = '';
		let biggest_disk = $(".container").width()/4;
		let margin = biggest_disk + biggest_disk/2;
		let unit_disk = '';
		let disks_input = total_disks = '';
		let arr_disk = [];
		let tower_height = ''; disks_in_tower1=disks_in_tower2=disks_in_tower3= '';
		let i = 1;

		class Disk {
			constructor(disks_input){
				this.disks_input = disks_input;
			}

			build_disk(){
				unit_disk = biggest_disk/disks_input;
				for (var i = 1; i<=disks_input; i++){
					svg.append("rect")
					.attr("x", function(){
						return (disks_input-i)*(unit_disk/2);
					})
					.attr("y", function(){
						return i*40+100;
					})
					.attr("width", function(){
						return i*unit_disk;
					})
					.attr("height",40)
					.attr("rx",10)
					.attr("ry",10)
					.attr("stroke-width", 1)
					.attr("stroke", "rgba(0,0,0,.5)")
					.classed("disk" + i + " color", true);

					arr_disk.push(d3.select(".disk" + i));
				}

				d3.selectAll(".color").style("fill", function() {
					return "hsl(" + Math.random() * 360 + ",100%,50%)";
				});
			}
		}

		class Tower {
			build_tower(){
				for (var j=0; j<3; j++){
					svg.append("rect")
					.attr("x", function(){
						return j*margin + (biggest_disk/2) - 5;
					})
					.attr("y", 140)
					.attr("rx", 10)
					.attr("ry", 10)
					.attr("width", 10)
					.attr("height", disks_input*40)
					.attr("fill", "rgba(105, 105, 105, 0.8)");
				}
				for (var j=0; j<3; j++){
					svg.append("rect")
					.attr("x", function(){
						return j*margin;
					})
					.attr("y", disks_input*40+140)
					.attr("rx", 10)
					.attr("ry", 10)
					.attr("width", biggest_disk)
					.attr("height", 10)
					.attr("fill", "rgba(105, 105, 105, 0.8)");
				}
			}
		}

		class GameEngine {
			move(n, tower1, tower2, tower3){
				if (n > 0) {
					this.move(n-1, tower1, tower3, tower2);

					if (tower1 == 0 && tower3 == margin){
						arr_disk[n-1]
						.transition()
						.delay(i*2000)
						.transition()
						.duration(750)
						.attr("y", 0)
						.transition()
						.duration(750)
						.attr("x", tower3+(total_disks-n)*(unit_disk/2))
						.transition()
						.duration(750)
						.attr("y", tower_height - disks_in_tower2*40+100);

						disks_in_tower1--; disks_in_tower2++;
						console.log("disks_in_tower1 " + disks_in_tower1 + ", disks_in_tower2 " + disks_in_tower2);
						i++;
					}

					if (tower1 == 0 && tower3 == 2*margin){
						arr_disk[n-1]
						.transition()
						.delay(i*2000)
						.transition()
						.duration(750)
						.attr("y", 0)
						.transition()
						.duration(750)
						.attr("x", tower3+(total_disks-n)*(unit_disk/2))
						.transition()
						.duration(750)
						.attr("y", tower_height - disks_in_tower3*40+100);

						disks_in_tower1--; disks_in_tower3++;
						console.log("disks_in_tower1 " + disks_in_tower1 + ", disks_in_tower3 " + disks_in_tower3);
						i++;
					}

					if (tower1 == margin && tower3 == 0){
						arr_disk[n-1]
						.transition()
						.delay(i*2000)
						.transition()
						.duration(750)
						.attr("y", 0)
						.transition()
						.duration(750)
						.attr("x", tower3+(total_disks-n)*(unit_disk/2))
						.transition()
						.duration(750)
						.attr("y", tower_height - disks_in_tower1*40+100);

						disks_in_tower2--; disks_in_tower1++;
						console.log("disks_in_tower1 " + disks_in_tower1 + ", disks_in_tower2 " + disks_in_tower2);
						i++;
					}

					if (tower1 == margin && tower3 == 2*margin){
						arr_disk[n-1]
						.transition()
						.delay(i*2000)
						.transition()
						.duration(750)
						.attr("y", 0)
						.transition()
						.duration(750)
						.attr("x", tower3+(total_disks-n)*(unit_disk/2))
						.transition()
						.duration(750)
						.attr("y", tower_height - disks_in_tower3*40+100);

						disks_in_tower2--; disks_in_tower3++;
						console.log("disks_in_tower2 " + disks_in_tower2 + ", disks_in_tower3 " + disks_in_tower3);
						i++;
					}

					if (tower1 == 2*margin && tower3 == margin){
						arr_disk[n-1]
						.transition()
						.delay(i*2000)
						.transition()
						.duration(750)
						.attr("y", 0)
						.transition()
						.duration(750)
						.attr("x", tower3+(total_disks-n)*(unit_disk/2))
						.transition()
						.duration(750)
						.attr("y", tower_height - disks_in_tower2*40+100);

						disks_in_tower2++; disks_in_tower3--;
						console.log("disks_in_tower2 " + disks_in_tower2 + ", disks_in_tower3 " + disks_in_tower3);
						i++;
					}

					if (tower1 == 2*margin && tower3 == 0){
						arr_disk[n-1]
						.transition()
						.delay(i*2000)
						.transition()
						.duration(750)
						.attr("y", 0)
						.transition()
						.duration(750)
						.attr("x", tower3+(total_disks-n)*(unit_disk/2))
						.transition()
						.duration(750)
						.attr("y", tower_height - disks_in_tower1*40+100);

						disks_in_tower1++; disks_in_tower3--;
						console.log("disks_in_tower1 " + disks_in_tower1 + ", disks_in_tower3 " + disks_in_tower3);
						i++;
					}

					console.log("Move disk " + n + " from " + tower1 + " to " + tower3);

					this.move(n-1, tower2, tower1, tower3);
				}
			}
		}

		function callbuild(){
			d3.selectAll("svg").remove();
			disks_input = Number($('input').val());

			try {
				if (isNaN(disks_input) || disks_input <= 0){
					throw "Xin mời nhập 1 số!";
				}
			}
			catch (e){
				alert("Xin mời nhập 1 số!");
				return;
			}

			arr_disk = []; disks_in_tower2=disks_in_tower3 = ''; i = 1;
			svg = d3.select(".container").append("svg").attr("width", $(".container").width()).attr("height", disks_input*40+200);
			tower_height = disks_input*40;
			disks_in_tower1 = total_disks = disks_input;
			let build_disk = new Disk(disks_input);
			let build_tower = new Tower();
			build_tower.build_tower();
			build_disk.build_disk();
		}

		function callmove(){
			disks_input = $('input').val();
			let gameEngine = new GameEngine(disks_input);
			let tower1 = 0; tower2 = margin; tower3 = 2*margin
			gameEngine.move(disks_input, tower1, tower2, tower3);
		}

	</script>
</body>
</html>